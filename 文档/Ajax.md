# Ajax

## 1、在搜索框处输入一个地址到最后看到页面,中间经历了哪些过程
**【请求阶段 request】**
+ 首先根据客户端输入的域名到DNS服务器上进行反解析(通过域名找到对应服务器的外网IP)
+ 通过找到的外网IP找到对应的服务器
+ 通过在地址栏输入的端口号(没输入是因为不同协议有自己默认的端口号)找到服务器上发布的对应的项目

**【响应阶段 response】**
+ 服务器获取到请求资源文件的地址,把资源文件中的'原代码'找到
+ 服务器端会把找到的源代码返回给客户端(通过http协议等传输协议返回的)

**【浏览器自主渲染】**
+ 客户端接收到原代码后,会交给浏览器的内核(渲染引擎)进行渲染,最后由浏览器绘制出对应的页面

----------

## 2、URL、URI、URN
+ URL：统一资源路径地址
+ URI：统一资源标识符
+ URN：统一资源名称

关系：URI=URL+URN
    
一个完整的URL包含很多部分

http://www.baidu.com/stuy/index.html?wd=json&name=szr&

**第一部分：传输协议**

* 传输协议是用来完成客户端和服务器的数据(内容)传输的(类似于快递小哥,负责将客户和商家的商品来回传递)

**【传输协议的理解】**
+ (1) 客户端不仅可以向服务器端发送请求,而且还可以把一些内容传递给服务器
+ (2) 服务器端也可以把内容返回给客户端
+ (3) Http报文 - 客户端和服务器端传输的内容
+ (4) Http事务 - request + response两个阶段
    + 1>  当client -> server request时,服务器端会建立一个传输通道,传输协议就是基于这个通道进行传输的
    + 2>  当server端接收到请求,把内容返回给客户端后,传输通道会自动销毁关闭

**【传输协议的分类】**
+ http - 超文本传输协议(client+server传输的内容,除了文本以外,还可以传输图片、音视频等文件流)
+ https - 比http更加安全,因为数据内容的传输通道是经过ssl加密的
+ ftp - 资源文件传输协议,一般用于客户端把资源文件上传到服务器端


**HTTP报文**

**【组成部分】**

+ 起始行
    + 请求起始行
    + 响应起始行
+ 首部(头)
    + 内置请求头、自定义请求头
    + 内置响应头、自定义响应头
    + 通用头(请求和响应都可以)
+ 主体
    + 请求主体
    + 响应主体

请求xxx都是客户端设置的信息,服务器端获取这些信息
响应xxx都是服务器端设置的信息,客户端用来接收这些信息

总结：
* client -> server
    + url问号传参
    + 设置请求头
    + 设置请求主体

* server -> client
    + 设置响应头
    + 设置响应主体


**第二部分：域名**

设置域名其实就是给不好记忆的服务器外网IP设置了一个好记忆的名字

+ 顶级域名 - qq.com
+ 二级域名 - www.qq.com
+ 三级域名 - kpq.sports.qq.com

**第三部分：端口号**

在服务器发布项目的时候,我们可以通过端口号区分当前服务器上不同的项目

一台服务器上的端口号取值范围 0~65535之间

Http -> 默认端口号 80
Https -> 默认端口号 443
Ftp -> 默认端口号 21

上述端口号是很重要的,如果被占用,就不能用了


**第四部分：请求资源文件的路径名称**

在发布项目的时候,一般会设置一些默认文档,即使不输入请求的文件名称,也会找到

我们通常为了做SEO优化,会把一些动态页面的地址(.php,.jsp,.aspx)进行伪Url重写(需要服务器处理的)

**第五部分：问号传参**

作用：
 - 在Ajax请求中,我们可以通过问号传参的方式,客户端把一些信息传递给服务器端,服务器端根据传递信息的不一样返回不同的数据
 - 消除Ajax请求中Get方式缓存

 -----------

 ## 3、基于原生js实现ajax
    // 1、创建一个ajax对象
    var xhr = new XMLHttpRequest();
    // 2、打开请求地址
    xhr.open([method],[url],[async],[user name],[user password]);  
    // 3、监听ajax状态改变,获取响应信息
    xhr.onreadystatechange = function(){
        if(xhr.readyState === 4 && xhr.status===200){
            // 获取响应主体中的内容
            var res = xhr.responseText;
        }
    }
    // 4、发送ajax请求(括号中传递的内容就是请求主体的内容)
    xhr.send(null);

### 3.1 分析第二步中的细节点

**【Ajax请求方式】**

1、Get系列请求(获取为主,给的少,拿回来的多)
- get
- delete (从服务器端删除某些资源文件)
- head (只想获取服务器返回的响应头信息)

2、Post系列请求(以推送为主,给的多,拿回来的少)
- post
- put (向服务器端增加指定的资源文件)

(1) 我们想获取一些动态展示的信息,一般使用get请求,因为只需要向服务器端发送请求,告诉服务器我们需要什么,服务器端就会把我们需要的数据进行返回

(2)在实现注册功能的时候,我们需要把客户输入的信息发送给服务器端进行存储,服务器一般会返回成功或者失败等状态,这种一般用post

**【Get和Post的区别】**

1、get请求传递给服务器的内容一般没有post请求传递给服务器的内容多

(**原因**：get请求是通过问号传参,post请求是通过设置请求主体来实现的;而且每一个浏览器会限制URL的最大长度,超出的部分会自动截取,从而导致传递给服务器的数据缺失)

2、get请求很容易出现缓存(这个缓存是不可控的),而post不会出现缓存,除非是自己设置

3、get请求没有post请求安全,而post也只是相对安全

**【剩下几个参数的意思】**

1、设置当前ajax是同步的还是异步的,不写默认是异步
+ ASYNC - 异步     
+ SYNC - 同步

2、用户名和密码一般不会用


### 3.2 Ajax状态码和网络状态码

1、Ajax状态码(readyState) - 描述当前ajax操作的状态码
- 0  【unset,未发送,只要创建一个ajax对象,默认值是零】
- 1  【opened,我们已经执行了xhr.open这个操作】
- 2  【headers_received,当前ajax请求已经发送,并且已经接收到响应头信息了】
- 3  【loading,响应主体内容正在返回的路上】
- 4  【done,响应主体内容已经返回到客户端】


2、Http网络状态码(status) - 记录了当前服务器返回信息的状态
- 200 成功,一个完整的http事务完成(以2开头的一般都是成功的)
- 以3开头的一般也是成功的,只不过是服务器端做了很多特殊的处理
    - 301 永久重定向(一般用于域名的迁移)
    - 302 临时转移(临时重定向)(一般用于服务器的负载均衡,当前服务器处理不了,我把当前请求临时交给其他的服务器进行处理)
    - 304 从缓存数据中获取数据(把一些不经常更新的额文件缓存到浏览器中,下一次从缓存中获取,减轻服务器的压力,提高页面的加载速度)
- 以4开头的,一般都是失败,而且客户端的问题偏大
    - 400 请求参数错误
    - 401 无权限访问
    - 404 访问地址不存在
- 以5开头的,一般都是失败的,而且服务器端的偏大
    - 500 未知的服务器错误
    - 503 服务器超负载

### 3.3 ajax中其他常用的属性和方法

**【属性】**

+ readyState - ajax状态码
+ response/responseText/responseXML - 都是用来接收服务器返回的内容,只是根据返回内容的格式不一样来用不同属性接收
+ status - http网络状态码
+ statusText - 对返回状态码的描述
+ timeout - 设置当前ajax请求的超时时间

**【方法】**

+ abort() - 强制中断ajax请求
+ getAllResponseHeaders() - 获取全部的响应头信息(获取的结果是一堆字符串文本)
+ getAllResponseHeader(key) - 获取指定的响应头信息
+ open() - 打开一个url地址
+ send() - 发送ajax请求
+ setRequestHeader(key,value) - 设置请求头信息

**【事件】**

+ onabort - 当ajax中断请求触发的这个事件
+ onreadystatechange - ajax状态发生改变
+ ontimeout - ajax请求超时
+ ... ....

### 3.4
    var xhr = new XMLHttpRequest();
    xhr.open('get','data.json?_='+Math.random(),true);
    xhr.onreadystatechange = () => {
        let {readyState:state,status} = xhr;
        // 说明请求数据成功了
        if(!/^(2|3)\d{2}$/.test(status)) return;

        //在状态为2的时候就可以获取获取响应头信息
        if(state===2){
            let headerAll = xhr.getAllResponseHeaders(),
                serverDate = xhr.getAllResponseHeader('date');
            return;
        }

        // 在状态为4的时候,响应主体的内容就已经回来了
        if(state===4){

        }
    }
    xhr.send();
-------------------

## 4、JQuery的ajax

    $.ajax({
        url:'请求的地址',
        method:'get',//=>get,post,在老版本的Jq中使用的是type
        dataType:'json',//=>只是我们预设的结果类型,不会影响服务器的返回(服务器一般都是给我们返回json格式的字符串)
        cache:false,//=>设置是否清除缓存,只对get系列请求有作用,默认值是true,Jq会在请求URL的末尾追加一个随机数来清除缓存
        data:{},//=>通过data可以把一些信息传递给服务器,get系列请求会把data中的内容拼接在url的末尾通过问号传参的形式传递给服务器;post系列请求会把内容放在请求主体中传递给服务器;data中的值可以设置两种格式：字符串和对象;如果是字符串,设置的值是什么传递给服务器的就是什么,如果设置的是对象,Jq会把对象转换为xxx=xxx&xxx=xxx这样格式的字符串传递给服务器
        success；function(){
            //=> 当ajax请求成功(readyState===4 && status是以2或者3开头的)
            //=> 请求成功后Jq会把传递的回调函数执行,并且把获取的结果当做实参传递给回调函数(result就是我们从服务器端获取的结果)
        },
        error:function(msg){
            //=> 请求错误触发
        },
        complete:function(){
            //=>不管是请求正确的还是错误的,都会触发回调函数
        }
    });